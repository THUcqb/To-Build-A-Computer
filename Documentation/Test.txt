ADDSP3 R0 0000
ADDSP3 R0 0000
NOP

;保存用户程序寄存器的地址 
;0xBF10  0xBF11 BF12 0xBF13 BF14 0xBF15
; R0    R1   R2   R3   R4   R5  

B 0061          ;START
NOP

DELINT:   ;中断处理程序
NOP
NOP
NOP
LI R6 00bf
SLL R6 R6 0000
ADDIU R6 0010
SW R6 R0 0000
SW R6 R1 0001
SW R6 R2 0002
SW R6 R4 0004
SW R6 R5 0005
LW-SP R1 0000
ADDSP 0001
LI R0 00ff
AND R1 R0
LW-SP R2 0000
ADDSP 0001
ADDSP ffff
SW-SP R3 0000
ADDSP ffff
SW-SP R7 0000
LI R3 000f
MFPC R7
ADDIU R7 0003
NOP
B 00ac
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R3 0000
NOP
LI R6 00bf
SLL R6 R6 0000
ADDIU R6 0010
LI R0 0000
CMP R0 R1
BTNEZ 0002
NOP
LW R6 R4 0007
LI R0 0020
CMP R0 R1
BTNEZ 0002
NOP
LW R6 R4 0008
LI R0 0010
CMP R0 R1
BTNEZ 0002
NOP
LW R6 R4 0009
NOP
LW R6 R5 0006
SLT R4 R5
BTNEZ 000b
NOP
SW R6 R4 0006
MFPC R7
ADDIU R7 0003
NOP
B 008b
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R1 0000
NOP
NOP
LI R3 000f
MFPC R7
ADDIU R7 0003
NOP
B 0080
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R3 0000
NOP
ADDIU3 R2 R6 0000
MFIH R3
LI R0 0080
SLL R0 R0 0000
OR R3 R0
LI R7 00bf
SLL R7 R7 0000
ADDIU R7 0010
LW R7 R0 0000
LW R7 R1 0001
LW R7 R2 0002
LW R7 R4 0004
LW R7 R5 0005
LW-SP R7 0000
ADDSP 0001
ADDSP 0001
NOP
MTIH R3
JR R6
LW-SP R3 00ff
NOP
LI R0 0007
MTIH R0
LI R0 00bf
SLL R0 R0 0000
ADDIU R0 0010
MTSP R0
NOP
LI R6 00bf
SLL R6 R6 0000
ADDIU R6 0010
LI R0 0000
SW R6 R0 0000
SW R6 R0 0001
SW R6 R0 0002
SW R6 R0 0003
SW R6 R0 0004
SW R6 R0 0005
SW R6 R0 0006
ADDIU R0 0001
SW R6 R0 0007
ADDIU R0 0001
SW R6 R0 0008
ADDIU R0 0001
SW R6 R0 0009
MFPC R7
ADDIU R7 0003
NOP
B 004a
LI R6 00bf
SLL R6 R6 0000
LI R0 004f
SW R6 R0 0000
NOP
MFPC R7
ADDIU R7 0003
NOP
B 0041
LI R6 00bf
SLL R6 R6 0000
LI R0 004b
SW R6 R0 0000
NOP
MFPC R7
ADDIU R7 0003
NOP
B 0038
LI R6 00bf
SLL R6 R6 0000
LI R0 000a
SW R6 R0 0000
NOP
MFPC R7
ADDIU R7 0003
NOP
B 002f
LI R6 00bf
SLL R6 R6 0000
LI R0 000d
SW R6 R0 0000
NOP

BEGIN:          ;检测命令
        ;接收字符，保存到r1

MFPC R7
ADDIU R7 0003
NOP
B 0031
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R1 0000
LI R6 00ff
AND R1 R6
NOP

;检测是否为R命令

LI R0 0052
CMP R0 R1
BTEQZ 0032
NOP

;检测是否为D命令

LI R0 0044
CMP R0 R1
BTEQZ 004d
NOP

;检测是否为A命令

LI R0 0041
CMP R0 R1
BTEQZ 000e
NOP

;检测是否为U命令

LI R0 0055
CMP R0 R1
BTEQZ 0007
NOP

;检测是否为G命令

LI R0 0047
CMP R0 R1
BTEQZ 0009
NOP

B ffe0
NOP

;各处理块的入口
GOTOUASM:
NOP
B 00c0
NOP
GOTOASM:
NOP
B 0082
NOP
GOTOCOMPILE:
NOP
B 0103
NOP

;测试8251是否能写
TESTW:  
NOP
LI R6 00bf
SLL R6 R6 0000
ADDIU R6 0001
LW R6 R0 0000
LI R6 0001
AND R0 R6
BEQZ R0 fff8
NOP
JR R7
NOP

;测试8251是否能读
TESTR:  
NOP
LI R6 00bf
SLL R6 R6 0000
ADDIU R6 0001
LW R6 R0 0000
LI R6 0002
AND R0 R6
BEQZ R0 fff8
NOP
JR R7
NOP

SHOWREGS:    ;R命令，打印R0-R5
LI R1 0006
LI R2 0006

LOOP:
LI R0 00bf
SLL R0 R0 0000
ADDIU R0 0010
SUBU R2 R1 R3
ADDU R0 R3 R0
LW R0 R3 0000

;发送低八位
MFPC R7
ADDIU R7 0003
NOP
B ffde
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R3 0000
;发送高八位
SRA R3 R3 0000
MFPC R7
ADDIU R7 0003
NOP
B ffd5
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R3 0000

ADDIU R1 ffff
NOP
BNEZ R1 ffe6 ;LOOP
NOP
B ffa2 ;BEGIN
NOP

SHOWMEM:  ;查看内存 
;D读取地址低位到r5
MFPC R7
ADDIU R7 0003
NOP
B ffd2
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R5 0000
LI R6 00ff
AND R5 R6
NOP

;读取地址高位到r1
MFPC R7
ADDIU R7 0003
NOP
B ffc7
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R1 0000
LI R6 00ff
AND R1 R6
NOP

;R1存储地址
SLL R1 R1 0000
OR R1 R5

;读取显示次数低位到R5
MFPC R7
ADDIU R7 0003
NOP
B ffba
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R5 0000
LI R6 00ff
AND R5 R6
NOP
;读取显示次数高位到R2
MFPC R7
ADDIU R7 0003
NOP
B ffaf
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R2 0000
LI R6 00ff
AND R2 R6
NOP
SLL R2 R2 0000
OR R2 R5

                ;循环发出   
        
MEMLOOP:

LW R1 R3 0000
MFPC R7
ADDIU R7 0003
NOP
B ff96
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R3 0000
SRA R3 R3 0000
MFPC R7
ADDIU R7 0003
NOP
B ff8d
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R3 0000
ADDIU R1 0001
ADDIU R2 ffff
NOP
BNEZ R2 ffea
NOP
B ff59
NOP

 ;汇编    
ASM:  

MFPC R7
ADDIU R7 0003
NOP
B ff89
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R5 0000
LI R6 00ff
AND R5 R6
NOP
MFPC R7
ADDIU R7 0003
NOP
B ff7e
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R1 0000
LI R6 00ff
AND R1 R6
NOP
SLL R1 R1 0000
OR R1 R5
LI R0 0000
CMP R0 R1
BTEQZ 001d
NOP
MFPC R7
ADDIU R7 0003
NOP
B ff6d
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R5 0000
LI R6 00ff
AND R5 R6
NOP
MFPC R7
ADDIU R7 0003
NOP
B ff62
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R2 0000
LI R6 00ff
AND R2 R6
NOP
SLL R2 R2 0000
OR R2 R5
SW R1 R2 0000
NOP
B ffc9
NOP
GOTOBEGIN:
NOP
B ff1e
NOP

;反汇编：将需要反汇编的地址处的值发给终端处理 
UASM:
;读取地址低位到r5
MFPC R7
ADDIU R7 0003
NOP
B ff4e
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R5 0000
LI R6 00ff
AND R5 R6
NOP
MFPC R7
ADDIU R7 0003
NOP
B ff43
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R1 0000
LI R6 00ff
AND R1 R6
NOP
SLL R1 R1 0000
OR R1 R5
MFPC R7
ADDIU R7 0003
NOP
B ff36
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R5 0000
LI R6 00ff
AND R5 R6
NOP
MFPC R7
ADDIU R7 0003
NOP
B ff2b
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R2 0000
LI R6 00ff
AND R2 R6
NOP
SLL R2 R2 0000
OR R2 R5

                ;循环发出           
UASMLOOP:                             

LW R1 R3 0000
MFPC R7
ADDIU R7 0003
NOP
B ff12
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R3 0000
SRA R3 R3 0000
MFPC R7
ADDIU R7 0003
NOP
B ff09
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R3 0000
ADDIU R1 0001
ADDIU R2 ffff
NOP
BNEZ R2 ffea
NOP
B fed5
NOP

;连续执行
COMPILE:

;读取地址低位到R5
MFPC R7
ADDIU R7 0003
NOP
B ff05
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R5 0000
LI R6 00ff
AND R5 R6
NOP
;读取内存高位到R2
MFPC R7
ADDIU R7 0003
NOP
B fefa
NOP
LI R6 00bf
SLL R6 R6 0000
LW R6 R2 0000
LI R6 00ff
AND R2 R6
NOP
;R2保存内存地址  传给r6
SLL R2 R2 0000
OR R2 R5
ADDIU3 R2 R6 0000

LI R7 00bf
SLL R7 R7 0000
ADDIU R7 0010

LW R7 R5 0005
ADDSP ffff
SW-SP R5 0000

;中断保存在R5中
MFIH R5
LI R1 0080
SLL R1 R1 0000
OR R5 R1

;恢复现场
LW R7 R0 0000
LW R7 R1 0001
LW R7 R2 0002
LW R7 R3 0003
LW R7 R4 0004


MFPC R7
ADDIU R7 0004
MTIH R5    ;IH高位赋1
JR R6
LW-SP R5 0000    ;R5恢复现场

;用户程序执行完毕，返回kernel，保存现场
NOP
NOP
ADDSP 0001
LI R7 00bf
SLL R7 R7 0000
ADDIU R7 0010

SW R7 R0 0000
SW R7 R1 0001
SW R7 R2 0002
SW R7 R3 0003
SW R7 R4 0004
SW R7 R5 0005
MFIH R0
LI R1 007f
SLL R1 R1 0000
LI R2 00ff
OR R1 R2
AND R0 R1
MTIH R0
LI R1 0007
MFPC R7
ADDIU R7 0003
NOP
B feb9
NOP
LI R6 00bf
SLL R6 R6 0000
SW R6 R1 0000
B fe8a
NOP